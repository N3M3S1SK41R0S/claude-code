{
  "name": "NEMESIS - Midjourney via GoAPI (FIXED)",
  "nodes": [
    {
      "parameters": {},
      "id": "webhook",
      "name": "Image Request",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 400],
      "webhookId": "midjourney"
    },
    {
      "parameters": {
        "functionCode": "// Validate and prepare request\n// NOTE: Midjourney has NO official API\n// This uses GoAPI.ai ($9/month) as third-party provider\n// Alternative: mymidjourney.ai, useapi.net\n\nconst input = $input.first().json;\nconst action = input.action || 'imagine';\n\nconst request = {\n  request_id: 'MJ-' + Date.now(),\n  timestamp: new Date().toISOString(),\n  action: action,\n  provider: 'goapi.ai'\n};\n\nif (action === 'imagine') {\n  let prompt = input.prompt || '';\n  const ar = input.aspect_ratio || '16:9';\n  const style = input.style || 'raw';\n  const quality = input.quality || 2;\n  const version = input.version || 6;\n  \n  // Build full Midjourney prompt with parameters\n  if (!prompt.includes('--ar')) prompt += ` --ar ${ar}`;\n  if (!prompt.includes('--style')) prompt += ` --style ${style}`;\n  if (!prompt.includes('--q')) prompt += ` --q ${quality}`;\n  if (!prompt.includes('--v')) prompt += ` --v ${version}`;\n  \n  request.prompt = prompt;\n  request.body = {\n    prompt: prompt,\n    aspect_ratio: ar,\n    process_mode: input.mode || 'fast',\n    webhook_endpoint: '',\n    webhook_secret: ''\n  };\n  request.endpoint = 'https://api.goapi.ai/mj/v2/imagine';\n  \n} else if (action === 'upscale') {\n  request.body = {\n    origin_task_id: input.task_id,\n    index: String(input.index || 1)\n  };\n  request.endpoint = 'https://api.goapi.ai/mj/v2/upscale';\n  \n} else if (action === 'variation') {\n  request.body = {\n    origin_task_id: input.task_id,\n    index: String(input.index || 1)\n  };\n  request.endpoint = 'https://api.goapi.ai/mj/v2/variation';\n  \n} else if (action === 'describe') {\n  request.body = { image_url: input.image_url };\n  request.endpoint = 'https://api.goapi.ai/mj/v2/describe';\n  \n} else if (action === 'status' || action === 'fetch') {\n  request.task_id = input.task_id;\n  request.endpoint = `https://api.goapi.ai/mj/v2/fetch/${input.task_id}`;\n  request.method = 'GET';\n}\n\nreturn [{ json: request }];"
      },
      "id": "prepare",
      "name": "Prepare Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [500, 400]
    },
    {
      "parameters": {
        "url": "={{ $json.endpoint }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "X-API-Key", "value": "={{ $env.GOAPI_API_KEY }}" }
          ]
        },
        "requestMethod": "={{ $json.method || 'POST' }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.body || {}) }}",
        "options": { "timeout": 60000 }
      },
      "id": "call-api",
      "name": "Call GoAPI",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [750, 400]
    },
    {
      "parameters": {
        "functionCode": "// Process GoAPI response\nconst response = $input.first().json;\nconst request = $('Prepare Request').first().json;\n\nconst result = {\n  request_id: request.request_id,\n  action: request.action,\n  timestamp: new Date().toISOString(),\n  provider: 'goapi.ai'\n};\n\n// Handle different response types\nif (response.task_id) {\n  result.task_id = response.task_id;\n  result.status = response.status || 'submitted';\n  result.progress = response.progress || 0;\n}\n\nif (response.status === 'finished' || response.status === 'completed') {\n  result.success = true;\n  result.status = 'completed';\n  result.image_url = response.task_result?.image_url || response.image_url;\n  result.image_urls = response.task_result?.image_urls || [];\n  result.seed = response.meta?.seed;\n  result.prompt = response.meta?.prompt || request.prompt;\n} else if (response.status === 'failed') {\n  result.success = false;\n  result.status = 'failed';\n  result.error = response.meta?.error_message || response.message || 'Unknown error';\n} else if (response.status === 'processing' || response.status === 'pending') {\n  result.success = null;\n  result.status = response.status;\n  result.message = 'Task in progress. Poll /webhook/midjourney with {\"action\": \"status\", \"task_id\": \"' + result.task_id + '\"}';\n} else if (response.error) {\n  result.success = false;\n  result.error = response.error;\n} else {\n  result.raw = response;\n}\n\nreturn [{ json: result }];"
      },
      "id": "process",
      "name": "Process Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1000, 400]
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={{ JSON.stringify($json) }}"
      },
      "id": "respond",
      "name": "Return Result",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1250, 400]
    }
  ],
  "connections": {
    "Image Request": {
      "main": [[{ "node": "Prepare Request", "type": "main", "index": 0 }]]
    },
    "Prepare Request": {
      "main": [[{ "node": "Call GoAPI", "type": "main", "index": 0 }]]
    },
    "Call GoAPI": {
      "main": [[{ "node": "Process Response", "type": "main", "index": 0 }]]
    },
    "Process Response": {
      "main": [[{ "node": "Return Result", "type": "main", "index": 0 }]]
    }
  },
  "settings": { "executionOrder": "v1" },
  "tags": ["nemesis", "midjourney", "ai", "images", "goapi", "fixed"],
  "notes": "IMPORTANT: Requires GoAPI.ai API key ($9/month). Set GOAPI_API_KEY in environment. Midjourney has NO official API - this uses a third-party provider."
}
