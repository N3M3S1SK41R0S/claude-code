{
  "name": "NEMESIS - WhatsApp via Twilio (FIXED)",
  "nodes": [
    {
      "parameters": {},
      "id": "whatsapp-webhook",
      "name": "WhatsApp Request",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 400],
      "webhookId": "whatsapp"
    },
    {
      "parameters": {
        "functionCode": "// WhatsApp Message Handler\n// FIXED: Uses Twilio WhatsApp API (easier setup than Meta Business API)\n// Meta API requires: Business verification, app review (weeks)\n// Twilio API requires: Account + WhatsApp sandbox (minutes)\n\nconst input = $input.first().json;\n\nconst request = {\n  request_id: 'WA-' + Date.now(),\n  timestamp: new Date().toISOString(),\n  provider: input.provider || 'twilio',\n  action: input.action || 'send'\n};\n\n// Format phone number for WhatsApp\nlet to = input.to || input.phone || '';\nif (!to.startsWith('whatsapp:')) {\n  to = 'whatsapp:' + to.replace(/[^0-9+]/g, '');\n}\nrequest.to = to;\n\n// Twilio sender\nrequest.from = `whatsapp:${process.env.TWILIO_WHATSAPP_NUMBER || '+14155238886'}`;\n\n// Message content\nrequest.message = input.message || input.body || input.text || '';\nrequest.media_url = input.media_url || input.image_url;\n\n// Handle incoming webhook from Twilio\nif (input.From && input.Body) {\n  request.action = 'incoming';\n  request.from = input.From;\n  request.to = input.To;\n  request.message = input.Body;\n  request.message_sid = input.MessageSid;\n  request.num_media = parseInt(input.NumMedia) || 0;\n  \n  // Auto-reply logic\n  const body = request.message.toLowerCase();\n  if (body.includes('bonjour') || body.includes('hello') || body.includes('salut')) {\n    request.auto_reply = 'Bonjour! ðŸ‘‹ Comment puis-je vous aider?';\n  } else if (body.includes('aide') || body.includes('help')) {\n    request.auto_reply = 'ðŸ“š Commandes disponibles:\\nâ€¢ AIDE - Cette aide\\nâ€¢ STATUS - Ã‰tat du systÃ¨me\\nâ€¢ INFO - Informations';\n  } else if (body.includes('status')) {\n    request.auto_reply = 'âœ… SystÃ¨me NEMESIS opÃ©rationnel';\n  }\n}\n\nreturn [{ json: request }];"
      },
      "id": "prepare",
      "name": "Prepare Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [500, 400]
    },
    {
      "parameters": {
        "conditions": {
          "string": [{ "value1": "={{ $json.action }}", "operation": "equals", "value2": "incoming" }]
        }
      },
      "id": "check-incoming",
      "name": "Incoming?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [750, 400]
    },
    {
      "parameters": {
        "url": "=https://api.twilio.com/2010-04-01/Accounts/{{ $env.TWILIO_ACCOUNT_SID }}/Messages.json",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            { "name": "From", "value": "={{ $json.from }}" },
            { "name": "To", "value": "={{ $json.to }}" },
            { "name": "Body", "value": "={{ $json.message }}" }
          ]
        },
        "options": {}
      },
      "id": "send-twilio",
      "name": "Send via Twilio",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1000, 500],
      "credentials": { "httpBasicAuth": { "id": "twilio-auth", "name": "Twilio Auth" } }
    },
    {
      "parameters": {
        "url": "=https://api.twilio.com/2010-04-01/Accounts/{{ $env.TWILIO_ACCOUNT_SID }}/Messages.json",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            { "name": "From", "value": "={{ $json.to }}" },
            { "name": "To", "value": "={{ $json.from }}" },
            { "name": "Body", "value": "={{ $json.auto_reply }}" }
          ]
        },
        "options": {}
      },
      "id": "send-auto-reply",
      "name": "Send Auto Reply",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1000, 250],
      "credentials": { "httpBasicAuth": { "id": "twilio-auth", "name": "Twilio Auth" } }
    },
    {
      "parameters": {
        "conditions": {
          "string": [{ "value1": "={{ $json.auto_reply }}", "operation": "isNotEmpty" }]
        }
      },
      "id": "check-auto-reply",
      "name": "Has Auto Reply?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1000, 100]
    },
    {
      "parameters": {
        "functionCode": "// Process response\nconst response = $input.first().json;\nconst request = $('Prepare Request').first().json;\n\nconst result = {\n  request_id: request.request_id,\n  timestamp: new Date().toISOString(),\n  action: request.action,\n  provider: 'twilio'\n};\n\nif (response.sid) {\n  result.success = true;\n  result.message_sid = response.sid;\n  result.status = response.status;\n  result.to = response.to;\n} else if (response.code) {\n  result.success = false;\n  result.error = response.message;\n  result.error_code = response.code;\n} else if (request.action === 'incoming') {\n  result.success = true;\n  result.received = {\n    from: request.from,\n    message: request.message,\n    auto_replied: !!request.auto_reply\n  };\n}\n\nreturn [{ json: result }];"
      },
      "id": "format-response",
      "name": "Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 400]
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={{ JSON.stringify($json) }}"
      },
      "id": "respond",
      "name": "Return Result",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1500, 400]
    }
  ],
  "connections": {
    "WhatsApp Request": {
      "main": [[{ "node": "Prepare Request", "type": "main", "index": 0 }]]
    },
    "Prepare Request": {
      "main": [[{ "node": "Incoming?", "type": "main", "index": 0 }]]
    },
    "Incoming?": {
      "main": [
        [{ "node": "Has Auto Reply?", "type": "main", "index": 0 }],
        [{ "node": "Send via Twilio", "type": "main", "index": 0 }]
      ]
    },
    "Has Auto Reply?": {
      "main": [
        [{ "node": "Send Auto Reply", "type": "main", "index": 0 }],
        [{ "node": "Format Response", "type": "main", "index": 0 }]
      ]
    },
    "Send Auto Reply": {
      "main": [[{ "node": "Format Response", "type": "main", "index": 0 }]]
    },
    "Send via Twilio": {
      "main": [[{ "node": "Format Response", "type": "main", "index": 0 }]]
    },
    "Format Response": {
      "main": [[{ "node": "Return Result", "type": "main", "index": 0 }]]
    }
  },
  "settings": { "executionOrder": "v1" },
  "tags": ["nemesis", "whatsapp", "twilio", "messaging", "fixed"],
  "notes": "FIXED: Uses Twilio WhatsApp API instead of Meta Business API. Setup: 1) Create Twilio account 2) Enable WhatsApp Sandbox 3) Set TWILIO_ACCOUNT_SID, TWILIO_AUTH_TOKEN, TWILIO_WHATSAPP_NUMBER"
}
