{
  "name": "NEMESIS - Backup to Cloud Storage (FIXED)",
  "nodes": [
    {
      "parameters": {
        "rule": { "interval": [{ "field": "days", "daysInterval": 1 }] }
      },
      "id": "daily-backup",
      "name": "Daily Backup",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {},
      "id": "manual-backup",
      "name": "Manual Backup",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 500],
      "webhookId": "backup"
    },
    {
      "parameters": {
        "functionCode": "// Initialize backup job\n// FIXED: Added cloud storage support (Google Drive, S3)\n// Original only logged to Notion without persistent storage\n\nconst backup = {\n  backup_id: 'BACKUP-' + new Date().toISOString().split('T')[0].replace(/-/g, '') + '-' + Date.now(),\n  started_at: new Date().toISOString(),\n  type: $input.first().json.type || 'full',\n  storage: $input.first().json.storage || 'google_drive',\n  targets: [\n    { name: 'n8n_workflows', status: 'pending' },\n    { name: 'n8n_credentials', status: 'pending' },\n    { name: 'notion_structure', status: 'pending' }\n  ],\n  stats: { total: 0, size_bytes: 0 }\n};\n\nreturn [{ json: backup }];"
      },
      "id": "init-backup",
      "name": "Initialize Backup",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [500, 400]
    },
    {
      "parameters": {
        "url": "http://localhost:5678/api/v1/workflows",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "backup-workflows",
      "name": "Get n8n Workflows",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [750, 300],
      "credentials": { "httpHeaderAuth": { "id": "n8n-cred", "name": "n8n API Key" } }
    },
    {
      "parameters": {
        "url": "https://api.notion.com/v1/search",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Notion-Version", "value": "2022-06-28" },
            { "name": "Authorization", "value": "Bearer {{ $env.NOTION_API_KEY }}" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{ \"filter\": { \"property\": \"object\", \"value\": \"database\" } }",
        "options": {}
      },
      "id": "backup-notion",
      "name": "Get Notion Structure",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [750, 500]
    },
    {
      "parameters": {
        "functionCode": "// Aggregate all backup data into single JSON\nconst items = $input.all();\nconst backupInfo = $('Initialize Backup').first().json;\n\nconst backupData = {\n  backup_id: backupInfo.backup_id,\n  created_at: new Date().toISOString(),\n  version: '1.0',\n  data: {\n    workflows: [],\n    notion: { databases: [] }\n  }\n};\n\nfor (const item of items) {\n  if (item.json.data && Array.isArray(item.json.data)) {\n    // n8n workflows\n    if (item.json.data[0]?.nodes) {\n      backupData.data.workflows = item.json.data;\n    }\n  } else if (item.json.results) {\n    // Notion databases\n    backupData.data.notion.databases = item.json.results.map(d => ({\n      id: d.id,\n      title: d.title?.[0]?.text?.content || 'Untitled',\n      url: d.url,\n      created: d.created_time\n    }));\n  }\n}\n\n// Calculate size\nconst jsonString = JSON.stringify(backupData, null, 2);\nbackupData.stats = {\n  workflows_count: backupData.data.workflows.length,\n  notion_databases_count: backupData.data.notion.databases.length,\n  size_bytes: jsonString.length,\n  size_kb: Math.round(jsonString.length / 1024)\n};\n\n// Prepare for upload\nbackupData.filename = `nemesis-backup-${backupInfo.backup_id}.json`;\nbackupData.content = jsonString;\n\nreturn [{ json: backupData }];"
      },
      "id": "aggregate-backup",
      "name": "Aggregate Backup Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1000, 400]
    },
    {
      "parameters": {
        "resource": "file",
        "operation": "upload",
        "name": "={{ $json.filename }}",
        "parents": ["={{ $env.GOOGLE_DRIVE_BACKUP_FOLDER }}"],
        "binaryPropertyName": "data",
        "options": {}
      },
      "id": "upload-gdrive",
      "name": "Upload to Google Drive",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 2,
      "position": [1250, 300],
      "credentials": { "googleDriveOAuth2Api": { "id": "gdrive-cred", "name": "Google Drive OAuth" } }
    },
    {
      "parameters": {
        "functionCode": "// Prepare binary data for upload\nconst backup = $input.first().json;\n\n// Convert JSON string to binary\nconst binaryData = Buffer.from(backup.content, 'utf8').toString('base64');\n\nreturn [{\n  json: backup,\n  binary: {\n    data: {\n      data: binaryData,\n      mimeType: 'application/json',\n      fileName: backup.filename,\n      fileExtension: 'json'\n    }\n  }\n}];"
      },
      "id": "prepare-binary",
      "name": "Prepare for Upload",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 500]
    },
    {
      "parameters": {
        "resource": "page",
        "operation": "create",
        "databaseId": "={{ $env.NOTION_BACKUP_LOG_DB }}",
        "propertiesUi": {
          "propertyValues": [
            { "key": "Name", "title": "={{ $json.backup_id }}" },
            { "key": "Type", "select": "Full" },
            { "key": "Workflows", "number": "={{ $json.stats.workflows_count }}" },
            { "key": "Size KB", "number": "={{ $json.stats.size_kb }}" },
            { "key": "Date", "date": "={{ $json.created_at }}" },
            { "key": "Status", "select": "Success" }
          ]
        }
      },
      "id": "log-backup",
      "name": "Log to Notion",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [1500, 400],
      "credentials": { "notionApi": { "id": "notion-cred", "name": "Notion API" } }
    },
    {
      "parameters": {
        "url": "={{ $env.DISCORD_WEBHOOK_URL }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ embeds: [{ title: 'ðŸ’¾ Backup Complete', color: 65280, fields: [{ name: 'ID', value: $json.backup_id, inline: true }, { name: 'Workflows', value: String($json.stats.workflows_count), inline: true }, { name: 'Size', value: $json.stats.size_kb + ' KB', inline: true }], footer: { text: 'Stored in Google Drive' }, timestamp: $json.created_at }] }) }}",
        "options": {}
      },
      "id": "notify-complete",
      "name": "Notify Complete",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1500, 600]
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={{ JSON.stringify({ success: true, backup_id: $json.backup_id, stats: $json.stats }) }}"
      },
      "id": "respond",
      "name": "Return Result",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1750, 400]
    }
  ],
  "connections": {
    "Daily Backup": {
      "main": [[{ "node": "Initialize Backup", "type": "main", "index": 0 }]]
    },
    "Manual Backup": {
      "main": [[{ "node": "Initialize Backup", "type": "main", "index": 0 }]]
    },
    "Initialize Backup": {
      "main": [[
        { "node": "Get n8n Workflows", "type": "main", "index": 0 },
        { "node": "Get Notion Structure", "type": "main", "index": 0 }
      ]]
    },
    "Get n8n Workflows": {
      "main": [[{ "node": "Aggregate Backup Data", "type": "main", "index": 0 }]]
    },
    "Get Notion Structure": {
      "main": [[{ "node": "Aggregate Backup Data", "type": "main", "index": 0 }]]
    },
    "Aggregate Backup Data": {
      "main": [[{ "node": "Prepare for Upload", "type": "main", "index": 0 }]]
    },
    "Prepare for Upload": {
      "main": [[
        { "node": "Upload to Google Drive", "type": "main", "index": 0 },
        { "node": "Log to Notion", "type": "main", "index": 0 },
        { "node": "Notify Complete", "type": "main", "index": 0 }
      ]]
    },
    "Log to Notion": {
      "main": [[{ "node": "Return Result", "type": "main", "index": 0 }]]
    }
  },
  "settings": { "executionOrder": "v1" },
  "tags": ["nemesis", "backup", "google-drive", "fixed"],
  "notes": "FIXED: Now uploads backups to Google Drive for persistent storage. Set GOOGLE_DRIVE_BACKUP_FOLDER with folder ID. Logs backup metadata to Notion."
}
