{
  "name": "NEMESIS - Discord Webhooks (FIXED - Outgoing Only)",
  "nodes": [
    {
      "parameters": {},
      "id": "webhook",
      "name": "Send Request",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 400],
      "webhookId": "discord"
    },
    {
      "parameters": {
        "functionCode": "// Discord Webhook Handler\n// NOTE: This workflow can only SEND messages to Discord\n// Receiving messages requires a WebSocket bot (not supported in n8n)\n// For receiving: Use a separate Discord bot that calls this n8n webhook\n\nconst input = $input.first().json;\n\nconst request = {\n  request_id: 'DISCORD-' + Date.now(),\n  timestamp: new Date().toISOString(),\n  action: input.action || 'send_message',\n  channel_id: input.channel_id,\n  guild_id: input.guild_id\n};\n\n// Validate required fields\nif (!input.channel_id && !input.webhook_url) {\n  request.valid = false;\n  request.error = 'Either channel_id or webhook_url is required';\n} else {\n  request.valid = true;\n}\n\n// Build message content\nif (input.action === 'send_embed' || input.embed) {\n  request.embed = {\n    title: input.embed_title || input.title,\n    description: input.embed_description || input.description || input.content,\n    color: parseInt(input.embed_color || input.color || '5814783'),\n    fields: input.embed_fields || input.fields || [],\n    footer: { text: input.footer || 'NEMESIS Hub' },\n    timestamp: new Date().toISOString()\n  };\n  if (input.thumbnail_url) request.embed.thumbnail = { url: input.thumbnail_url };\n  if (input.image_url) request.embed.image = { url: input.image_url };\n}\n\nif (input.message || input.content) {\n  request.content = input.message || input.content;\n}\n\n// Use Discord webhook URL directly if provided\nif (input.webhook_url) {\n  request.use_webhook = true;\n  request.webhook_url = input.webhook_url;\n}\n\nreturn [{ json: request }];"
      },
      "id": "prepare",
      "name": "Prepare Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [500, 400]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [{ "value1": "={{ $json.use_webhook }}", "value2": true }]
        }
      },
      "id": "check-method",
      "name": "Use Webhook URL?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [750, 400]
    },
    {
      "parameters": {
        "url": "={{ $json.webhook_url }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ content: $json.content || '', embeds: $json.embed ? [$json.embed] : [], username: 'NEMESIS Bot' }) }}",
        "options": {}
      },
      "id": "send-via-webhook",
      "name": "Send via Webhook URL",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1000, 250]
    },
    {
      "parameters": {
        "url": "=https://discord.com/api/v10/channels/{{ $json.channel_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "Bot {{ $env.DISCORD_BOT_TOKEN }}" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ content: $json.content || '', embeds: $json.embed ? [$json.embed] : [] }) }}",
        "options": {}
      },
      "id": "send-via-bot",
      "name": "Send via Bot Token",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1000, 500]
    },
    {
      "parameters": {
        "url": "=https://discord.com/api/v10/guilds/{{ $json.guild_id }}/channels",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "Bot {{ $env.DISCORD_BOT_TOKEN }}" }
          ]
        },
        "options": {}
      },
      "id": "get-channels",
      "name": "Get Channels",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1000, 700]
    },
    {
      "parameters": {
        "functionCode": "// Format Discord response\nconst response = $input.first().json;\nconst request = $('Prepare Message').first().json;\n\nconst result = {\n  request_id: request.request_id,\n  timestamp: new Date().toISOString(),\n  success: true\n};\n\nif (response.id) {\n  result.message_id = response.id;\n  result.channel_id = response.channel_id;\n} else if (response.code) {\n  result.success = false;\n  result.error = response.message;\n  result.error_code = response.code;\n}\n\nreturn [{ json: result }];"
      },
      "id": "format-response",
      "name": "Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 400]
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={{ JSON.stringify($json) }}"
      },
      "id": "respond",
      "name": "Return Result",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1500, 400]
    }
  ],
  "connections": {
    "Send Request": {
      "main": [[{ "node": "Prepare Message", "type": "main", "index": 0 }]]
    },
    "Prepare Message": {
      "main": [[{ "node": "Use Webhook URL?", "type": "main", "index": 0 }]]
    },
    "Use Webhook URL?": {
      "main": [
        [{ "node": "Send via Webhook URL", "type": "main", "index": 0 }],
        [{ "node": "Send via Bot Token", "type": "main", "index": 0 }]
      ]
    },
    "Send via Webhook URL": {
      "main": [[{ "node": "Format Response", "type": "main", "index": 0 }]]
    },
    "Send via Bot Token": {
      "main": [[{ "node": "Format Response", "type": "main", "index": 0 }]]
    },
    "Get Channels": {
      "main": [[{ "node": "Format Response", "type": "main", "index": 0 }]]
    },
    "Format Response": {
      "main": [[{ "node": "Return Result", "type": "main", "index": 0 }]]
    }
  },
  "settings": { "executionOrder": "v1" },
  "tags": ["nemesis", "discord", "webhooks", "messaging", "fixed"],
  "notes": "OUTGOING ONLY - Can send messages to Discord via Bot Token or Webhook URL. Cannot receive messages (requires WebSocket bot). For receiving, set up a Discord bot that POSTs to this webhook."
}
